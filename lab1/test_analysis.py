#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
"""

import numpy as np
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # –î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ GUI
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats
from scipy.stats import norm, chi2, kstest
import warnings
warnings.filterwarnings('ignore')

def test_analysis():
    """–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∞–Ω–∞–ª–∏–∑–∞"""
    print("üî¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...")
    
    # –î–∞–Ω–Ω—ã–µ –æ –í–í–ü –Ω–∞ –¥—É—à—É –Ω–∞—Å–µ–ª–µ–Ω–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –ë–µ–ª–∞—Ä—É—Å–∏ (—Ç—ã—Å. —Ä—É–±–ª–µ–π)
    gdp_data = {
        'region': [
            '–≥. –ú–∏–Ω—Å–∫', '–ú–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ì–æ–º–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ë—Ä–µ—Å—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–í–∏—Ç–µ–±—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ì—Ä–æ–¥–Ω–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ú–æ–≥–∏–ª–µ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–ë–æ—Ä–∏—Å–æ–≤—Å–∫–∏–π —Ä-–Ω', '–î–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ö–ª–µ—Ü–∫–∏–π —Ä-–Ω', '–õ–æ–≥–æ–π—Å–∫–∏–π —Ä-–Ω',
            '–õ—é–±–∞–Ω—Å–∫–∏–π —Ä-–Ω', '–ú–æ–ª–æ–¥–µ—á–Ω–µ–Ω—Å–∫–∏–π —Ä-–Ω', '–ú—è–¥–µ–ª—å—Å–∫–∏–π —Ä-–Ω', '–ù–µ—Å–≤–∏–∂—Å–∫–∏–π —Ä-–Ω',
            '–ü—É—Ö–æ–≤–∏—á—Å–∫–∏–π —Ä-–Ω', '–°–ª—É—Ü–∫–∏–π —Ä-–Ω', '–°–º–æ–ª–µ–≤–∏—á—Å–∫–∏–π —Ä-–Ω', '–°–æ–ª–∏–≥–æ—Ä—Å–∫–∏–π —Ä-–Ω',
            '–°—Ç–∞—Ä–æ–¥–æ—Ä–æ–∂—Å–∫–∏–π —Ä-–Ω', '–°—Ç–æ–ª–±—Ü–æ–≤—Å–∫–∏–π —Ä-–Ω', '–£–∑–¥–µ–Ω—Å–∫–∏–π —Ä-–Ω', '–ß–µ—Ä–≤–µ–Ω—Å–∫–∏–π —Ä-–Ω',
            '–ì–æ–º–µ–ª—å—Å–∫–∏–π —Ä-–Ω', '–ë—Ä–∞–≥–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ë—É–¥–∞-–ö–æ—à–µ–ª–µ–≤—Å–∫–∏–π —Ä-–Ω', '–í–µ—Ç–∫–æ–≤—Å–∫–∏–π —Ä-–Ω',
            '–î–æ–±—Ä—É—à—Å–∫–∏–π —Ä-–Ω', '–ï–ª—å—Å–∫–∏–π —Ä-–Ω', '–ñ–ª–æ–±–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ñ–∏—Ç–∫–æ–≤–∏—á—Å–∫–∏–π —Ä-–Ω',
            '–ö–∞–ª–∏–Ω–∫–æ–≤–∏—á—Å–∫–∏–π —Ä-–Ω', '–ö–æ—Ä–º—è–Ω—Å–∫–∏–π —Ä-–Ω', '–õ–µ–ª—å—á–∏—Ü–∫–∏–π —Ä-–Ω', '–õ–æ–µ–≤—Å–∫–∏–π —Ä-–Ω',
            '–ú–æ–∑—ã—Ä—Å–∫–∏–π —Ä-–Ω', '–ù–∞—Ä–æ–≤–ª—è–Ω—Å–∫–∏–π —Ä-–Ω', '–û–∫—Ç—è–±—Ä—å—Å–∫–∏–π —Ä-–Ω', '–ü–µ—Ç—Ä–∏–∫–æ–≤—Å–∫–∏–π —Ä-–Ω',
            '–†–µ—á–∏—Ü–∫–∏–π —Ä-–Ω', '–†–æ–≥–∞—á–µ–≤—Å–∫–∏–π —Ä-–Ω', '–°–≤–µ—Ç–ª–æ–≥–æ—Ä—Å–∫–∏–π —Ä-–Ω', '–•–æ–π–Ω–∏–∫—Å–∫–∏–π —Ä-–Ω',
            '–ë–∞—Ä–∞–Ω–æ–≤–∏—á—Å–∫–∏–π —Ä-–Ω', '–ë–µ—Ä–µ–∑–æ–≤—Å–∫–∏–π —Ä-–Ω', '–ë—Ä–µ—Å—Ç—Å–∫–∏–π —Ä-–Ω', '–ì–∞–Ω—Ü–µ–≤–∏—á—Å–∫–∏–π —Ä-–Ω',
            '–î—Ä–æ–≥–∏—á–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ñ–∞–±–∏–Ω–∫–æ–≤—Å–∫–∏–π —Ä-–Ω', '–ò–≤–∞–Ω–æ–≤—Å–∫–∏–π —Ä-–Ω', '–ò–≤–∞—Ü–µ–≤–∏—á—Å–∫–∏–π —Ä-–Ω',
            '–ö–∞–º–µ–Ω–µ—Ü–∫–∏–π —Ä-–Ω', '–ö–æ–±—Ä–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–õ—É–Ω–∏–Ω–µ—Ü–∫–∏–π —Ä-–Ω', '–õ—è—Ö–æ–≤–∏—á—Å–∫–∏–π —Ä-–Ω',
            '–ú–∞–ª–æ—Ä–∏—Ç—Å–∫–∏–π —Ä-–Ω', '–ü–∏–Ω—Å–∫–∏–π —Ä-–Ω', '–ü—Ä—É–∂–∞–Ω—Å–∫–∏–π —Ä-–Ω', '–°—Ç–æ–ª–∏–Ω—Å–∫–∏–π —Ä-–Ω'
        ],
        'gdp_per_capita': [
            28.5, 16.2, 14.8, 13.9, 12.1, 13.6, 11.9,
            15.8, 14.2, 11.3, 12.7, 10.9, 13.4, 11.8, 12.5,
            13.1, 14.6, 15.2, 19.3, 10.7, 12.9, 11.2, 13.8,
            14.1, 8.9, 10.3, 9.7, 11.5, 9.2, 12.8, 10.6,
            11.7, 9.4, 8.5, 8.1, 13.2, 7.9, 9.8, 9.1,
            12.4, 10.9, 14.3, 8.7,
            12.6, 10.8, 13.5, 9.3, 8.9, 11.4, 8.6, 11.9,
            9.5, 12.1, 10.2, 9.7, 8.4, 11.6, 10.5, 9.8
        ]
    }
    
    # –°–æ–∑–¥–∞–µ–º DataFrame
    df = pd.DataFrame(gdp_data)
    data = df['gdp_per_capita'].values
    
    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(data)} —Ä–µ–≥–∏–æ–Ω–æ–≤")
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    n = len(data)
    mean_val = np.mean(data)
    median_val = np.median(data)
    std_val = np.std(data, ddof=1)
    coeff_var = (std_val / mean_val) * 100
    
    print(f"‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:")
    print(f"   –†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏: {n}")
    print(f"   –°—Ä–µ–¥–Ω–µ–µ: {mean_val:.3f}")
    print(f"   –ú–µ–¥–∏–∞–Ω–∞: {median_val:.3f}")
    print(f"   –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏: {coeff_var:.2f}%")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–æ—Å–æ–≤
    outliers_indices = []
    for i, value in enumerate(data):
        if abs(value - median_val) > 3 * median_val:
            outliers_indices.append(i)
    
    if outliers_indices:
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤—ã–±—Ä–æ—Å–æ–≤: {len(outliers_indices)}")
        data_clean = np.delete(data, outliers_indices)
    else:
        print("‚úÖ –í—ã–±—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        data_clean = data.copy()
    
    # –§–æ—Ä–º—É–ª–∞ –°—Ç–µ—Ä–¥–∂–µ—Å—Å–∞
    n_clean = len(data_clean)
    s = 1 + int(np.log2(n_clean))
    print(f"‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø–æ –°—Ç–µ—Ä–¥–∂–µ—Å—Å—É: {s}")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª)
    plt.figure(figsize=(10, 6))
    plt.hist(data_clean, bins=s, alpha=0.7, color='skyblue', edgecolor='black')
    plt.title('–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –í–í–ü –Ω–∞ –¥—É—à—É –Ω–∞—Å–µ–ª–µ–Ω–∏—è')
    plt.xlabel('–í–í–ü –Ω–∞ –¥—É—à—É –Ω–∞—Å–µ–ª–µ–Ω–∏—è (—Ç—ã—Å. —Ä—É–±.)')
    plt.ylabel('–ß–∞—Å—Ç–æ—Ç–∞')
    plt.grid(True, alpha=0.3)
    plt.savefig('test_histogram.png', dpi=300, bbox_inches='tight')
    plt.close()
    print("‚úÖ –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ test_histogram.png")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏
    shapiro_stat, shapiro_p = stats.shapiro(data_clean)
    print(f"‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π –®–∞–ø–∏—Ä–æ-–£–∏–ª–∫–∞: p = {shapiro_p:.4f}")
    
    # –ê–Ω–∞–ª–∏–∑ –¥–∏—Å–ø–µ—Ä—Å–∏–π
    min_val = np.min(data_clean)
    max_val = np.max(data_clean)
    bins = np.linspace(min_val, max_val, s + 1)
    
    # –ì—Ä—É–ø–ø–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    group_sizes = []
    group_means = []
    
    for i in range(len(bins) - 1):
        mask = (data_clean >= bins[i]) & (data_clean < bins[i + 1])
        if i == len(bins) - 2:
            mask = (data_clean >= bins[i]) & (data_clean <= bins[i + 1])
        
        group_data = data_clean[mask]
        if len(group_data) > 0:
            group_sizes.append(len(group_data))
            group_means.append(np.mean(group_data))
        else:
            group_sizes.append(0)
            group_means.append(0)
    
    overall_mean = np.mean(data_clean)
    between_var = sum(n_i * (mean_i - overall_mean)**2 for n_i, mean_i in zip(group_sizes, group_means)) / n_clean
    total_var = np.var(data_clean, ddof=1)
    between_ratio = between_var / total_var * 100
    
    print(f"‚úÖ –î–æ–ª—è –º–µ–∂–≥—Ä—É–ø–ø–æ–≤–æ–π –¥–∏—Å–ø–µ—Ä—Å–∏–∏: {between_ratio:.2f}%")
    
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!")
    print("üìä –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –≤ Jupyter Notebook")
    
    return True

if __name__ == "__main__":
    test_analysis()
